<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALEX GO! - Incident Reporting Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />

  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    /* Title bar */
    #appTitle{
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:11; background:rgba(255,255,255,.9); padding:10px 20px;
      font:bold 28px/1 Arial,sans-serif; color:#0079c1; border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.15);
    }

    /* Buttons */
    #addReportBtn,#basemapSelector{
      position:absolute; right:10px; background:#fff; z-index:10; padding:10px;
    }
    #addReportBtn{ top:60px; }
    #basemapSelector{ top:120px; }
    #addReportBtn button{
      font-size:18px; padding:12px 24px; background:#0079c1; color:#fff;
      border:none; border-radius:5px; cursor:pointer;
    }
    #addReportBtn button:hover{ background:#005a87; }

    /* Unified legend container */
    #legendContainer{
      position:absolute; bottom:20px; left:10px; z-index:12;
      background:#fff; border-radius:6px; padding:10px;
      font-family:Arial,sans-serif; font-size:14px;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
      max-width:240px;
    }
    #legendContainer strong{ display:block; margin-bottom:6px; }
    #dispatchRow img{
      height:24px; vertical-align:middle; margin-right:6px;
    }
    #dispatchRow{ margin-bottom:6px; }
  </style>

  <script src="https://js.arcgis.com/4.25/"></script>
</head>
<body>

  <!-- Title -->
  <div id="appTitle">Alex Go!</div>

  <!-- Add-Report button -->
  <div id="addReportBtn">
    <button onclick="addReport()">Add Report</button>
  </div>

  <!-- Basemap selector -->
  <div id="basemapSelector">
    <label for="basemapSelect">Basemap:</label>
    <select id="basemapSelect" onchange="changeBasemap(this.value)">
      <option value="streets">Street</option>
      <option value="topo" selected>Terrain</option>
      <option value="satellite">Vegetation (Satellite)</option>
      <option value="hybrid">Structures (Hybrid)</option>
    </select>
  </div>

  <!-- Map -->
  <div id="viewDiv"></div>

  <!-- Unified legend -->
  <div id="legendContainer">
    <strong>Legend</strong>
    <!-- Custom dispatch-worker entry -->
    <div id="dispatchRow">
      <img src="https://raw.githubusercontent.com/hstepanus/Geog576_Midterm_real/main/dispatch_worker.png" alt="Dispatch Worker">
      Dispatch Worker Center
    </div>
    <!-- ArcGIS legend will be injected here -->
    <div id="arcgisLegend"></div>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/Legend",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/symbols/PictureMarkerSymbol"
    ], function(Map, MapView, Search, Locate, Legend,
                FeatureLayer, GraphicsLayer, Graphic, Point, PictureMarkerSymbol){

      /* -------------------------------------------------- */
      /* Map & view                                         */
      /* -------------------------------------------------- */
      const map = new Map({ basemap:"topo" });

      const view = new MapView({
        container:"viewDiv",
        map,
        center:[-77.5,38.5],
        zoom:9
      });

      /* -------------------------------------------------- */
      /* Layers                                             */
      /* -------------------------------------------------- */
      const territoryLayer = new FeatureLayer({
        url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/drive_download_20250623T221527Z_1_001/FeatureServer/0",
        opacity:0.5,
        title:"Service Territory"
      });
      map.add(territoryLayer);

      const incidentLayer = new FeatureLayer({
        url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_dbec98d452884e3ca51548ab0ca97c1f_form/FeatureServer/0",
        outFields:["*"],
        title:"Incident Reports",
        popupTemplate:{
          title:"{report_type}",
          content:"{description}<br>Status: {status}"
        }
      });
      map.add(incidentLayer);

      /* Dispatch worker graphics */
      const officeIcon = new PictureMarkerSymbol({
        url:"https://raw.githubusercontent.com/hstepanus/Geog576_Midterm_real/main/dispatch_worker.png",
        width:"28px", height:"28px"
      });

      const officeLayer = new GraphicsLayer();
      const offices = [
        { name:"Lomond Service Center",      coords:[-77.506083,38.782611] },
        { name:"Minnieville Service Center", coords:[-77.358306,38.635944] },
        { name:"Gainesville Office",         coords:[-77.565797,38.778760] },
        { name:"Balls Ford HQ",              coords:[-77.510306,38.800801] },
        { name:"Evergreen Mills Center",     coords:[-77.567000,38.992000] },
        { name:"Stafford County Office",     coords:[-77.407997,38.422932] }
      ];
      offices.forEach(o=>{
        officeLayer.add(new Graphic({
          geometry:new Point({ longitude:o.coords[0], latitude:o.coords[1] }),
          symbol:officeIcon,
          attributes:{ name:o.name },
          popupTemplate:{ title:o.name }
        }));
      });
      map.add(officeLayer); // not in ArcGIS legend widget

      /* -------------------------------------------------- */
      /* Widgets                                            */
      /* -------------------------------------------------- */
      view.ui.add(new Search({ view }), "top-left");
      view.ui.add(new Locate({ view }), "top-left");
      view.ui.move("zoom","bottom-right");

      /* Embed ArcGIS legend into custom container */
      new Legend({
        view,
        container:"arcgisLegend",
        layerInfos:[
          { layer:territoryLayer },
          { layer:incidentLayer }
        ]
      });

      /* -------------------------------------------------- */
      /* Add-report workflow                                */
      /* -------------------------------------------------- */
      window.addReport = () => {
        view.popup.open({
          title:"New Report",
          content:createReportForm(),
          location:view.center
        });
      };

      function createReportForm(){
        const div=document.createElement("div");
        div.innerHTML=`
          <label>Type:</label><br>
          <select id="reportType">
            <option value="Blackout">Blackout</option>
            <option value="Electrical Failure">Electrical Failure</option>
            <option value="Fire">Fire</option>
            <option value="Obstruction">Obstruction</option>
          </select><br><br>
          <label>Description:</label><br>
          <textarea id="description" rows="4" cols="30"></textarea><br><br>
          <button onclick="submitReport()">Submit</button>`;
        return div;
      }

      window.submitReport = () => {
        const type=document.getElementById("reportType").value;
        const desc=document.getElementById("description").value;
        const pt=new Point({ longitude:view.center.longitude, latitude:view.center.latitude });

        incidentLayer.applyEdits({
          addFeatures:[ new Graphic({
            geometry:pt,
            attributes:{
              report_type:type,
              description:desc,
              report_time:new Date().toISOString(),
              status:"open"
            }
          }) ]
        }).then(()=>{ alert("Report submitted!"); view.popup.close(); });
      };

      /* -------------------------------------------------- */
      /* Basemap switcher                                   */
      /* -------------------------------------------------- */
      window.changeBasemap = name => { map.basemap = name; };

    });
  </script>
</body>
</html>
