<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALEX GO! - Incident Reporting Map</title>

  <!-- ArcGIS JS API stylesheet -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">

  <style>
    html, body, #viewDiv { margin: 0; padding: 0; height: 100%; width: 100%; }

    /* App title */
    #appTitle{
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:11; background:rgba(255,255,255,.9); padding:10px 20px;
      font: bold 28px/1 Arial, sans-serif; color:#0079c1; border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.15);
    }

    /* Controls */
    #addReportBtn,#basemapSelector{
      position:absolute; right:10px; background:#fff; z-index:10; padding:10px;
    }
    #addReportBtn{ top:60px; }
    #basemapSelector{ top:120px; }

    /* Button */
    #addReportBtn button{
      font-size:18px; padding:12px 24px; background:#0079c1; color:#fff;
      border:none; border-radius:5px; cursor:pointer;
    }
    #addReportBtn button:hover{ background:#005a87; }
  </style>

  <!-- ArcGIS JavaScript API -->
  <script src="https://js.arcgis.com/4.25/"></script>
</head>
<body>

  <!-- UI -->
  <div id="appTitle">Alex Go!</div>

  <div id="addReportBtn">
    <button onclick="addReport()">Add Report</button>
  </div>

  <div id="basemapSelector">
    <label for="basemapSelect">Basemap:</label>
    <select id="basemapSelect" onchange="changeBasemap(this.value)">
      <option value="streets">Street</option>
      <option value="topo" selected>Terrain</option>
      <option value="satellite">Vegetation (Satellite)</option>
      <option value="hybrid">Structures (Hybrid)</option>
    </select>
  </div>

  <div id="viewDiv"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/Search",
      "esri/widgets/Locate",
      "esri/widgets/Legend",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/symbols/PictureMarkerSymbol"
    ], function(Map, MapView, Search, Locate, Legend,
                FeatureLayer, GraphicsLayer, Graphic, Point, PictureMarkerSymbol){

      /* ------------------------------------------------------------------ */
      /* 1.  Base map & view                                               */
      /* ------------------------------------------------------------------ */
      const map = new Map({ basemap:"topo" });

      const view = new MapView({
        container:"viewDiv",
        map, center:[-77.5,38.5], zoom:9
      });

      /* ------------------------------------------------------------------ */
      /* 2.  Service-territory layer                                        */
      /* ------------------------------------------------------------------ */
      const territoryLayer = new FeatureLayer({
        url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/drive_download_20250623T221527Z_1_001/FeatureServer/0",
        opacity:0.5,
        title:"Service Territory"
      });
      map.add(territoryLayer);

      /* ------------------------------------------------------------------ */
      /* 3.  Incident reports layer                                         */
      /* ------------------------------------------------------------------ */
      const incidentLayer = new FeatureLayer({
        url:"https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/survey123_dbec98d452884e3ca51548ab0ca97c1f_form/FeatureServer/0",
        outFields:["*"],
        title:"Incident Reports",
        popupTemplate:{
          title:"{report_type}",
          content:"{description}<br>Status: {status}"
        }
      });
      map.add(incidentLayer);

      /* ------------------------------------------------------------------ */
      /* 4.  District-office icons layer                                    */
      /* ------------------------------------------------------------------ */
      const officeIcon = new PictureMarkerSymbol({
        url:"https://raw.githubusercontent.com/hstepanus/Geog576_Midterm_real/main/dispatch_worker.png",
        width:"32px", height:"32px"
      });

      const officeLayer = new GraphicsLayer({ title:"District Offices" });

      const offices = [
        {name:"Lomond Service Center",       coords:[-77.506083,38.782611]},
        {name:"Minnieville Service Center",  coords:[-77.358306,38.635944]},
        {name:"Gainesville Office",          coords:[-77.565797,38.778760]},
        {name:"Balls Ford HQ (Suite 220)",   coords:[-77.510306,38.800801]},
        {name:"Evergreen Mills Service Ctr", coords:[-77.567000,38.992000]}, // approx.
        {name:"Stafford County Office",      coords:[-77.407997,38.422932]}  // approx.
      ];

      offices.forEach(o=>{
        const g = new Graphic({
          geometry: new Point({ longitude:o.coords[0], latitude:o.coords[1] }),
          symbol: officeIcon,
          attributes:{ name:o.name },
          popupTemplate:{ title:o.name }
        });
        officeLayer.add(g);
      });

      map.add(officeLayer);

      /* ------------------------------------------------------------------ */
      /* 5.  UI widgets                                                     */
      /* ------------------------------------------------------------------ */
      const search  = new Search({ view });
      const locate  = new Locate({ view });
      const legend  = new Legend({
        view,
        layerInfos:[
          { layer:territoryLayer },
          { layer:incidentLayer },
          { layer:officeLayer }   // shows icon in legend
        ]
      });

      view.ui.add(search,"top-left");
      view.ui.add(locate,"top-left");
      view.ui.add(legend,"bottom-left");
      view.ui.move("zoom","bottom-right");

      /* ------------------------------------------------------------------ */
      /* 6.  Add-report workflow                                            */
      /* ------------------------------------------------------------------ */
      window.addReport = function(){
        view.popup.open({
          title:"New Report",
          content:createReportForm(),
          location:view.center
        });
      };

      function createReportForm(){
        const div = document.createElement("div");
        div.innerHTML=`
          <label>Type:</label><br>
          <select id="reportType">
            <option value="Blackout">Blackout</option>
            <option value="Electrical Failure">Electrical Failure</option>
            <option value="Fire">Fire</option>
            <option value="Obstruction">Obstruction</option>
          </select><br><br>
          <label>Description:</label><br>
          <textarea id="description" rows="4" cols="30"></textarea><br><br>
          <button onclick="submitReport()">Submit</button>`;
        return div;
      }

      window.submitReport = function(){
        const type = document.getElementById("reportType").value;
        const desc = document.getElementById("description").value;

        const pt = new Point({
          longitude:view.center.longitude,
          latitude:view.center.latitude
        });

        const newReport = new Graphic({
          geometry:pt,
          attributes:{
            report_type:type,
            description:desc,
            report_time:new Date().toISOString(),
            status:"open"
          }
        });

        incidentLayer.applyEdits({ addFeatures:[newReport] })
          .then(()=>{ alert("Report submitted!"); view.popup.close(); });
      };

      /* ------------------------------------------------------------------ */
      /* 7.  Basemap switcher                                               */
      /* ------------------------------------------------------------------ */
      window.changeBasemap = basemapName => { map.basemap = basemapName; };

    });
  </script>
</body>
</html>
